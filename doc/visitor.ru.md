# Визиторы (Visitors)

Визиторы — это классы, которые модифицируют абстрактное синтаксическое дерево (AST) исходного кода для генерации моков.
В пакете уже включены несколько готовых визиторов, но также есть возможность создавать собственные.

## Встроенные визиторы

### 1. `PublicAndConstFilter`

**Назначение:**  
Оставляет только публичные методы и константы в классах и трейтах. Все остальные элементы (защищённые, приватные методы
и свойства) удаляются.

**Параметры конструктора:**

- `$skipThrowable` (bool, необязательный): Если `true`, классы, являющиеся потомками `Throwable` или `Exception`, будут
  пропущены.

**Пример использования:**

```php
new \Vasoft\MockBuilder\Visitor\PublicAndConstFilter(true);
```

---

### 2. `SetReturnTypes`

**Назначение:**  
Добавляет типы возвращаемых значений к методам на основе PHPDoc-комментариев или явно заданных типов из конфигурации.
Если тип уже указан, он не изменяется.

**Параметры конструктора:**

- `$targetPhpVersion` (string, необязательный): Версия PHP, для которой генерируются типы. По умолчанию используется
  текущая версия PHP.
- `$skipThrowable` (bool, необязательный): Если `true`, классы, являющиеся потомками `Throwable` или `Exception`, будут
  пропущены.

**Особенности работы:**

1. **Обработка PHPDoc:**
    - Типы определяются на основе тега `@return` в PHPDoc-комментариях.
    - Поддерживаются объединённые типы (например, `string|int`), nullable-типы (например, `?int`) и специальные типы,
      такие как `$this` (заменяется на `static`) и `void`.

2. **Явные типы из конфигурации:**
    - В конфигурации можно указать массив `resultTypes`, где ключами являются полные имена методов (в
      формате `ClassName::methodName`), а значениями — их возвращаемые типы.
    - Явно заданные типы имеют приоритет над типами, определёнными через PHPDoc.

3. **Совместимость с версиями PHP:**
    - Для версий PHP ниже 8.2 тип `'true'` заменяется на `'bool'`.
    - Nullable-типы обрабатываются корректно, даже если они указаны вручную или через PHPDoc.

**Пример использования:**

```php
new \Vasoft\MockBuilder\Visitor\SetReturnTypes('8.1', true);
```

**Пример конфигурации с явными типами:**

```php
return [
    'basePath' => ['/path/to/source'],
    'targetPath' => '/path/to/target',
    'resultTypes' => [
        '\Vendor\System\MyClass::myMethod' => 'string',
        '\Vendor\Other\AnotherClass::anotherMethod' => '?int',
    ],
];
```

**Пример исходного кода:**

```php
class MyClass
{
    /**
     * @return string|int
     */
    public function myMethod()
    {
        // No return type or PHPDoc
    }
}
```

**Результат:**

```php
class MyClass
{
    public function myMethod(): string|int
    {
        // Body cleared
    }
}
```

---

### 3. `AddMockToolsVisitor`

**Назначение:**  
Добавляет специальный трейт `MockTools` в каждый обработанный класс или трейт. Этот трейт позволяет контролировать
поведение моков во время тестирования.

**Параметры конструктора:**

- `$baseNamespace` (string): Базовое пространство имён, в которое будет скопирован трейт `MockTools`.
- `$skipThrowable` (bool, необязательный): Если `true`, классы, являющиеся потомками `Throwable` или `Exception`, будут
  пропущены.

**Примечание:**  
Трейт `MockTools` копируется в целевую директорию с обновлением пространства имён. Это делает моки автономными, так как
они не зависят от исходного пакета.

**Пример использования:**

```php
new \Vasoft\MockBuilder\Visitor\AddMockToolsVisitor('App', true);
```

---

### 4.  `RemoveFinalVisitor`

AST визитор для удаления модификатора `final` у классов и методов

---

## Создание собственных визиторов

Вы можете создавать собственные визиторы для реализации дополнительной логики обработки AST. Для этого необходимо:

1. **Унаследовать класс от `ModuleVisitor`:**  
   Все визиторы должны быть унаследованы от `\Vasoft\MockBuilder\Visitor\ModuleVisitor`.

2. **Реализовать методы обработки AST:**
    - Метод `leaveNode($node)` вызывается при выходе из узла AST. В нём можно модифицировать узлы или выполнять
      проверки.
    - Метод `beforeProcess()` вызывается перед началом обработки файлов. Может использоваться для выполнения
      подготовительных действий.

3. **Добавить визитор в конфигурацию:**  
   Добавьте экземпляр вашего визитора в массив `visitors` конфигурационного файла.

**Пример простого визитора:**

```php
<?php

declare(strict_types=1);

namespace MyApp\Visitor;

use PhpParser\Node;
use Vasoft\MockBuilder\Visitor\ModuleVisitor;

class MyCustomVisitor extends ModuleVisitor
{
    public function leaveNode($node)
    {
        if ($node instanceof Node\Stmt\Class_) {
            // Добавляем комментарий к каждому классу
            $node->setAttribute('comments', [
                new \PhpParser\Comment("// This class was processed by MyCustomVisitor"),
            ]);
        }

        return null;
    }
}
```

**Добавление в конфигурацию:**

```php
'visitors' => [
    new \MyApp\Visitor\MyCustomVisitor(),
],
```

---

## Заключение

Встроенные визиторы предоставляют базовый набор функциональности для генерации моков, но вы всегда можете расширить их,
создав собственные визиторы. Это позволяет адаптировать утилиту под конкретные требования вашего проекта.